{% trans_default_domain 'cocorico_listing' %}

{#search form fields without start ane end form#}

<fieldset>
    <legend class="hidden">form-category</legend>
    <div class="form-holder">
        <div class="col categories">
            <strong class="title">
                {{ form_label(form.categories) }}
            </strong>

            <div class="multiselect">
                {{ form_widget(form.categories) }}
            </div>
        </div>


        <div class="col location">
            <strong class="title">
                {{ form_label(form.location.address, null, {
                    'required': false
                }) }}
            </strong>

            <div class="field-holder">
                {{ form_errors(form.location.address) }}
                {{ form_widget(form.location.address, {
                    'id': 'location',
                    'attr': {
                        'class': 'form-control',
                        'placeholder': 'listing.search.form.address.placeholder'|trans
                    }
                } ) }}
                {{ form_rest(form.location) }}
            </div>
        </div>

        <div class="col time">
            {#In case of modification don't forget to add fields "start, end AND nb_days" #}
            {{ form_widget(form.date_range) }}

            {% if timeUnitFlexibility and form.flexibility is defined %}
                <div class="col flexibility">
                    <strong class="title">
                        {{ form_label(form.flexibility) }}
                    </strong>

                    <div class="input-append field-holder">
                        {{ form_errors(form.flexibility) }}
                        {{ form_widget(form.flexibility, {
                            'attr': {
                                'class' : 'no-arrow'
                            }
                        }) }}
                        <small>{{ 'listing_search.form.flexibility_day'|trans }}</small>
                    </div>
                </div>
            {% endif %}

            {% if not timeUnitIsDay %}
                {{ form_widget(form.time_range) }}
            {% endif %}
        </div>

        <input id="search" type="" value="{{ 'listing.search'|trans }}" class="btn btn-default">
    </div>
</fieldset>

<script>
    document.getElementById("categories").removeAttribute("multiple");

    function setCookie(){
        var address = document.getElementById('location').value;
        var lat = document.getElementById('location_lat').value;
        var lng = document.getElementById('location_lng').value;
        var viewport = document.getElementById('location_viewport').value;
        var country = document.getElementById('location_country').value;
        var area = document.getElementById('location_area').value;
        var department = document.getElementById('location_department').value;
        var city  = document.getElementById('location_city').value;
        var zip = document.getElementById('location_zip').value;
        var route = document.getElementById('location_route').value;
        var streetNumber = document.getElementById('location_streetNumber').value;
        var addressType = document.getElementById('location_addressType').value;
        document.cookie = "address="+address;
        document.cookie = "lat="+lat;
        document.cookie = "lng="+lng;
        document.cookie = "viewport="+viewport;
        document.cookie = "country="+country;
        document.cookie = "area="+area;
        document.cookie = "department="+department;
        document.cookie = "city="+city;
        document.cookie = "zip="+zip;
        document.cookie = "route="+route;
        document.cookie = "streetNumber="+streetNumber;
        document.cookie = "addressType="+addressType;
    }

    function getCategoryName(){
        const category_id = document.getElementById("categories").value;
        if(category_id){
            var category = document.getElementById('categories').childNodes;
            var i =0;
            var category_name = '';
            while(i < category.length){
                if(i%2){
                    const value = category[i].getAttribute('value');
                    if( value === category_id){
                        category_name  = category[i].innerHTML.trim();
                        break;
                    }
                }
                i++;
            }

            const index = category_name.lastIndexOf("/");
            if(index !== -1){
                category_name = category_name.slice(0,index);
            } else{
                const ind = category_name.lastIndexOf(" ");
                if (ind !== -1){
                    category_name = category_name.slice(0,ind);
                }
            }
            category_name = category_name.replace("/","-").trim();
            category_name = category_name.replace(" ","-");
            category_name = category_name.toLowerCase();
            if (category_name === 'live'){category_name = 'band'}
            else if (category_name === 'photo'){category_name = 'photographer'}
            else if (category_name === 'variety'){category_name = 'variety-artist'}
            else if (category_name === 'make-up-artist'){category_name = 'makeup-artist'}

            return category_name;
        } else{
            return false;
        }
    }

    function getLocation(){
        var location = document.getElementById("location").value;
        if(location){
            const index = location.lastIndexOf(",");
            if(index == '-1'){
                location = location.slice(0);
            } else{
                location = location.slice(0,index);
            }
            location = location.replace(/\, /g,"-");   //replaces all occurrence of ', ' by '-'
            location = location.replace(" ","-");
            location = location.toLowerCase();
            return location;
        }
        else{
            return false;
        }
    }

    document.getElementById("search").onclick = function(e){
        e.preventDefault();
        var category_name = getCategoryName();
        if(category_name){
            var location =  getLocation();
            if (location){
                setCookie();
                window.location.assign('/book-'+category_name+'-online/'+location);
            } else{
                setCookie();
                window.location.assign("http://"+domain+"/book-"+category_name+"-online");
            }
        } else{
            alert("Please select a category to search for.");
        }
    };
</script>

